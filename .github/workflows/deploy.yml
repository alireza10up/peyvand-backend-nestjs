- name: Deploy to Server
        run: |
          ssh -i ~/.ssh/id_rsa -p 7544 fincho@154.16.16.2 << 'EOF'
          echo "ğŸš€ Starting Deployment..."
          cd /home/fincho
          if [ ! -d "peyvand-backend-nestjs/.git" ]; then
            echo "âš ï¸ Repository not found, cloning again..."
            git clone git@github.com:alireza10up/peyvand-backend-nestjs.git peyvand-backend-nestjs
          fi
          cd peyvand-backend-nestjs
          
          git config --global user.email "ci@fincho.ir"
          git config --global user.name "Peyvand CI"
          
          echo "ğŸ“‚ Current Directory: $(pwd)"
          echo "ğŸ“„ Directory Content:"
          ls -la
          
          git reset --hard
          git pull origin develop
          npm install --legacy-peer-deps
          # Create .env file from GitHub Secrets
          echo "${{ secrets.ENV_VARS }}" > .env
          # Run migrations 
          echo "ğŸš€ Running Migrations..."
          npm run migrate || echo "âš ï¸ No migration script found."
          # Restart app with pm2
          pm2 delete peyvand || true
          pm2 start npm --name "peyvand" --cwd /home/fincho/peyvand-backend-nestjs -- run start
          
          echo "âœ… Deployment Finished!"
          EOF
